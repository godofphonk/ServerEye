# Ð˜Ð¼Ñ workflow - Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒÑÑ Ð½Ð° GitHub
name: CI

# ÐšÐ¾Ð³Ð´Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ workflow?
on:
  push:
    branches: [ master, main ]  # ÐŸÑ€Ð¸ push Ð² master Ð¸Ð»Ð¸ main
    tags: [ 'v*' ]  # ÐŸÑ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ñ‚ÐµÐ³Ð¾Ð² v*
  pull_request:
    branches: [ master, main ]  # ÐŸÑ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Pull Request

# ÐšÐ°ÐºÐ¸Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸ (jobs) Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑ‚ÑŒ?
jobs:
  # Job 1: Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
  build:
    name: Build and Test
    runs-on: ubuntu-latest  # ÐÐ° ÐºÐ°ÐºÐ¾Ð¹ ÐžÐ¡ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ (GitHub Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾)
    
    steps:
      # Ð¨Ð°Ð³ 1: Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ ÐºÐ¾Ð´ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Go
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'  # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð´Ð»Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      
      # Ð¨Ð°Ð³ 3: ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð»Ð¾)
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-
            ${{ runner.os }}-go-
      
      # Ð¨Ð°Ð³ 4: Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      - name: Download dependencies
        run: go mod download
      
      # Ð¨Ð°Ð³ 5: ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð´ ÐºÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÑ‚ÑÑ
      - name: Build bot
        run: go build -v ./cmd/bot
      
      - name: Build agent
        run: go build -v ./cmd/agent
      
      # Ð¨Ð°Ð³ 6: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÐµ ÑŽÐ½Ð¸Ñ‚-Ñ‚ÐµÑÑ‚Ñ‹ (287 Ñ‚ÐµÑÑ‚Ð¾Ð² Ð´Ð»Ñ agent + bot)
      - name: Run unit tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          rm -f coverage.txt
          go test -short -race -coverprofile=coverage.txt -covermode=atomic ./...
      
      # Ð¨Ð°Ð³ 6.1: Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¿Ð¾ Ð¼Ð¾Ð´ÑƒÐ»ÑÐ¼
      - name: Show detailed coverage
        run: |
          echo "ðŸ“Š Coverage Report by Module:"
          echo "=============================="
          go tool cover -func=coverage.txt | grep -E "internal/agent|internal/bot" || true
          echo ""
          echo "ðŸ“ˆ Total Coverage:"
          go tool cover -func=coverage.txt | grep "^total:" || echo "Coverage report generated"
      
      # Ð¨Ð°Ð³ 6.2: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾)
      - name: Check coverage threshold
        continue-on-error: true
        run: |
          COVERAGE=$(go tool cover -func=coverage.txt | grep "^total:" | awk '{print $3}' | sed 's/%//' || echo "0")
          echo "Current coverage: ${COVERAGE}%"
          # Ð–ÐµÐ»Ð°ÐµÐ¼Ð¾Ðµ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ 40%
          THRESHOLD=40
          RESULT=$(awk -v cov="$COVERAGE" -v thr="$THRESHOLD" 'BEGIN { print (cov >= thr) ? "OK" : "FAIL" }')
          if [ "$RESULT" = "FAIL" ]; then
            echo "âš ï¸  Coverage ${COVERAGE}% is below ${THRESHOLD}% threshold (warning only)"
          else
            echo "âœ… Coverage ${COVERAGE}% meets threshold"
          fi
      
      # Ð¨Ð°Ð³ 7: Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ coverage report (Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ ÐºÐ°ÐºÐ°Ñ Ñ‡Ð°ÑÑ‚ÑŒ ÐºÐ¾Ð´Ð° Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð° Ñ‚ÐµÑÑ‚Ð°Ð¼Ð¸)
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.txt
          fail_ci_if_error: false  # ÐÐµ Ð¿Ñ€Ð¾Ð²Ð°Ð»Ð¸Ñ‚ÑŒ CI ÐµÑÐ»Ð¸ codecov Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
  
  # Job 2: Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹
  module-tests:
    name: Module Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        module:
          - internal/agent
          - internal/bot
          - pkg/protocol
          - pkg/metrics
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Test ${{ matrix.module }}
        run: |
          echo "ðŸ§ª Testing ${{ matrix.module }}..."
          go test -v -short -cover ./${{ matrix.module }}/...
  
  # Job 3: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð´Ð° (Linting)
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ golangci-lint - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ ÐºÐ¾Ð´ Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¸ ÑÑ‚Ð¸Ð»ÑŒ
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m  # Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚ 5 Ð¼Ð¸Ð½ÑƒÑ‚
  
  # Job 4: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ ÐºÐ¾Ð´Ð° (Security Scan)
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Run Gosec Security Scanner
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          echo "ðŸ”’ Running security scan..."
          gosec -fmt=text ./... || echo "âš ï¸ Security issues found (non-blocking)"
  
  # Job 5: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ…
  vulnerability-check:
    name: Vulnerability Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Download dependencies
        run: go mod download
      
      - name: Check for vulnerabilities
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...
      
      - name: Check for outdated dependencies
        continue-on-error: true
        run: |
          echo "ðŸ“¦ Checking dependencies..."
          go list -u -m all

  # Job 6: Build DEV images (Ð½Ð° ÐºÐ°Ð¶Ð´Ñ‹Ð¹ push Ð² master)
  docker-build-dev:
    name: Build DEV Images
    runs-on: ubuntu-latest
    needs: [build, lint]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push DEV Bot image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployments/Dockerfile.bot
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/servereye-bot:dev
            ghcr.io/${{ github.repository_owner }}/servereye-bot:dev-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push DEV Agent image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployments/Dockerfile.agent
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/servereye-agent:dev
            ghcr.io/${{ github.repository_owner }}/servereye-agent:dev-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: DEV Summary
        run: |
          echo "ðŸ§ª DEV images published:"
          echo "ðŸ¤– Bot: ghcr.io/${{ github.repository_owner }}/servereye-bot:dev"
          echo "ðŸ–¥ï¸ Agent: ghcr.io/${{ github.repository_owner }}/servereye-agent:dev"
          echo ""
          echo "âš¡ DEV bot will auto-update in ~1 minute!"
  
  # Job 7: Build PROD images (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ€ÐµÐ»Ð¸Ð·Ð¾Ð²)
  docker-build-prod:
    name: Build PROD Images
    runs-on: ubuntu-latest
    needs: [build, lint]
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Build and push PROD Bot image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployments/Dockerfile.bot
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/servereye-bot:stable
            ghcr.io/${{ github.repository_owner }}/servereye-bot:latest
            ghcr.io/${{ github.repository_owner }}/servereye-bot:${{ steps.version.outputs.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push PROD Agent image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployments/Dockerfile.agent
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/servereye-agent:stable
            ghcr.io/${{ github.repository_owner }}/servereye-agent:latest
            ghcr.io/${{ github.repository_owner }}/servereye-agent:${{ steps.version.outputs.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: PROD Summary
        run: |
          echo "ðŸš€ PRODUCTION images published:"
          echo "ðŸ¤– Bot: ghcr.io/${{ github.repository_owner }}/servereye-bot:stable"
          echo "ðŸ¤– Bot: ghcr.io/${{ github.repository_owner }}/servereye-bot:latest"
          echo "ðŸ¤– Bot: ghcr.io/${{ github.repository_owner }}/servereye-bot:${{ steps.version.outputs.VERSION }}"
          echo ""
          echo "âœ… PROD bot will update to stable version!"

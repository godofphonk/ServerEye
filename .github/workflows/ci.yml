# –ò–º—è workflow - –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –Ω–∞ GitHub
name: CI

# –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å —ç—Ç–æ—Ç workflow?
on:
  push:
    branches: [ master, main ]  # –ü—Ä–∏ push –≤ master –∏–ª–∏ main
  pull_request:
    branches: [ master, main ]  # –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Pull Request

# –ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ (jobs) –≤—ã–ø–æ–ª–Ω—è—Ç—å?
jobs:
  # Job 1: –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  build:
    name: Build and Test
    runs-on: ubuntu-latest  # –ù–∞ –∫–∞–∫–æ–π –û–° –∑–∞–ø—É—Å–∫–∞—Ç—å (GitHub –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
    
    steps:
      # –®–∞–≥ 1: –°–∫–∞—á–∞—Ç—å –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4
      
      # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Go
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'  # –í–µ—Ä—Å–∏—è Go –∏–∑ —Ç–≤–æ–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
      
      # –®–∞–≥ 3: –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (—á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–µ–µ —Ä–∞–±–æ—Ç–∞–ª–æ)
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-
            ${{ runner.os }}-go-
      
      # –®–∞–≥ 4: –°–∫–∞—á–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Download dependencies
        run: go mod download
      
      # –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è
      - name: Build bot
        run: go build -v ./cmd/bot
      
      - name: Build agent
        run: go build -v ./cmd/agent
      
      # –®–∞–≥ 6: –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã (287 —Ç–µ—Å—Ç–æ–≤ –¥–ª—è agent + bot)
      - name: Run unit tests
        run: |
          echo "üß™ Running unit tests..."
          rm -f coverage.txt
          go test -short -race -coverprofile=coverage.txt -covermode=atomic ./...
      
      # –®–∞–≥ 6.1: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –ø–æ –º–æ–¥—É–ª—è–º
      - name: Show detailed coverage
        run: |
          echo "üìä Coverage Report by Module:"
          echo "=============================="
          go tool cover -func=coverage.txt | grep -E "internal/agent|internal/bot" || true
          echo ""
          echo "üìà Total Coverage:"
          go tool cover -func=coverage.txt | grep "^total:" || echo "Coverage report generated"
      
      # –®–∞–≥ 6.2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
      - name: Check coverage threshold
        continue-on-error: true
        run: |
          COVERAGE=$(go tool cover -func=coverage.txt | grep "^total:" | awk '{print $3}' | sed 's/%//' || echo "0")
          echo "Current coverage: ${COVERAGE}%"
          # –ñ–µ–ª–∞–µ–º–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ 40%
          THRESHOLD=40
          RESULT=$(awk -v cov="$COVERAGE" -v thr="$THRESHOLD" 'BEGIN { print (cov >= thr) ? "OK" : "FAIL" }')
          if [ "$RESULT" = "FAIL" ]; then
            echo "‚ö†Ô∏è  Coverage ${COVERAGE}% is below ${THRESHOLD}% threshold (warning only)"
          else
            echo "‚úÖ Coverage ${COVERAGE}% meets threshold"
          fi
      
      # –®–∞–≥ 7: –ó–∞–≥—Ä—É–∑–∏—Ç—å coverage report (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫–∞—è —á–∞—Å—Ç—å –∫–æ–¥–∞ –ø–æ–∫—Ä—ã—Ç–∞ —Ç–µ—Å—Ç–∞–º–∏)
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.txt
          fail_ci_if_error: false  # –ù–µ –ø—Ä–æ–≤–∞–ª–∏—Ç—å CI –µ—Å–ª–∏ codecov –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
  
  # Job 2: –î–µ—Ç–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π
  module-tests:
    name: Module Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        module:
          - internal/agent
          - internal/bot
          - pkg/protocol
          - pkg/metrics
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Test ${{ matrix.module }}
        run: |
          echo "üß™ Testing ${{ matrix.module }}..."
          go test -v -short -cover ./${{ matrix.module }}/...
  
  # Job 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ (Linting)
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      # –ó–∞–ø—É—Å–∫–∞–µ–º golangci-lint - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ –Ω–∞ –æ—à–∏–±–∫–∏ –∏ —Å—Ç–∏–ª—å
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m  # –¢–∞–π–º–∞—É—Ç 5 –º–∏–Ω—É—Ç

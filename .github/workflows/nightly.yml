name: Nightly Tests

# ĞŸĞ¾Ğ»Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹ ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ½Ğ¾Ñ‡ÑŒ (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ)
on:
  schedule:
    - cron: '0 2 * * *'  # ĞšĞ°Ğ¶Ğ´ÑƒÑ Ğ½Ğ¾Ñ‡ÑŒ Ğ² 2:00 UTC
  workflow_dispatch:  # ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ

jobs:
  full-test-suite:
    name: Full Test Suite (Unit + Integration)
    runs-on: ubuntu-latest
    
    services:
      # Redis Ğ´Ğ»Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ñ… Ñ‚ĞµÑÑ‚Ğ¾Ğ²
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      # PostgreSQL Ğ´Ğ»Ñ Ğ‘Ğ” Ñ‚ĞµÑÑ‚Ğ¾Ğ²
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: servereye_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test123
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Setup Docker (for Docker-in-Docker tests)
        uses: docker/setup-buildx-action@v3
      
      - name: Download dependencies
        run: go mod download
      
      # Ğ®Ğ½Ğ¸Ñ‚-Ñ‚ĞµÑÑ‚Ñ‹ (Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ) - 287 Ñ‚ĞµÑÑ‚Ğ¾Ğ²
      - name: Run unit tests
        run: |
          echo "ğŸ§ª Running 287+ unit tests..."
          go test -v -short -coverprofile=unit-coverage.txt ./...
          echo ""
          echo "ğŸ“Š Unit Test Coverage:"
          go tool cover -func=unit-coverage.txt | grep "^total:"
      
      # Ğ¢ĞµÑÑ‚Ñ‹ Ğ¿Ğ¾ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑĞ¼ Ñ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸ĞµĞ¼
      - name: Test agent module
        run: |
          echo "ğŸ¤– Testing internal/agent (287 tests, 46.6% coverage)..."
          go test -v -short -cover ./internal/agent/...
      
      - name: Test bot module
        run: |
          echo "ğŸ¤– Testing internal/bot..."
          go test -v -short -cover ./internal/bot/...
      
      - name: Test pkg modules
        run: |
          echo "ğŸ“¦ Testing pkg modules..."
          go test -v -short -cover ./pkg/...
      
      # Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹ (Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑĞ¼Ğ¸)
      - name: Run integration tests (skipped for now)
        env:
          REDIS_ADDRESS: localhost:6379
          POSTGRES_DSN: "postgres://test:test123@localhost:5432/servereye_test?sslmode=disable"
        run: |
          echo "ğŸ”— Integration tests currently skipped (t.Skip in code)"
          echo "Available services:"
          echo "  - Redis: $REDIS_ADDRESS"
          echo "  - PostgreSQL: $POSTGRES_DSN"
          echo ""
          echo "To enable: Remove t.Skip() from integration tests"
          # ĞšĞ¾Ğ³Ğ´Ğ° Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹:
          # go test -v -tags=integration -coverprofile=integration-coverage.txt ./...
      
      - name: Generate test report
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Nightly Test Report"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Unit Tests Coverage:"
          go tool cover -func=unit-coverage.txt | grep "^total:"
          echo ""
          echo "Coverage by Module:"
          go tool cover -func=unit-coverage.txt | grep -E "internal/agent|internal/bot"
          echo ""
          echo "âœ… All tests passed!"
          
      - name: Notify on failure
        if: failure()
        run: echo "âŒ Nightly tests failed!"

  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'
      
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: results.sarif

  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Check for outdated dependencies
        run: |
          go list -u -m all
          
      - name: Check for vulnerabilities
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

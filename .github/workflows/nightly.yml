name: Nightly Tests

# –ü–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã –∫–∞–∂–¥—É—é –Ω–æ—á—å (–≤–∫–ª—é—á–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ)
on:
  schedule:
    - cron: '0 2 * * *'  # –ö–∞–∂–¥—É—é –Ω–æ—á—å –≤ 2:00 UTC
  workflow_dispatch:  # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  full-test-suite:
    name: Full Test Suite (Unit + Integration)
    runs-on: ubuntu-latest
    
    services:
      # Redis –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      # PostgreSQL –¥–ª—è –ë–î —Ç–µ—Å—Ç–æ–≤
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: servereye_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test123
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Setup Docker (for Docker-in-Docker tests)
        uses: docker/setup-buildx-action@v3
      
      - name: Download dependencies
        run: go mod download
      
      # –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã (–±—ã—Å—Ç—Ä—ã–µ)
      - name: Run unit tests
        run: go test -v -short -coverprofile=unit-coverage.txt ./...
      
      # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (–º–µ–¥–ª–µ–Ω–Ω—ã–µ, —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏)
      - name: Run integration tests
        env:
          REDIS_ADDRESS: localhost:6379
          POSTGRES_DSN: "postgres://test:test123@localhost:5432/servereye_test?sslmode=disable"
        run: |
          # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å t.Skip() –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö
          echo "Running integration tests..."
          # TODO: –ö–æ–≥–¥–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã:
          # go test -v -tags=integration -coverprofile=integration-coverage.txt ./...
      
      - name: Generate test report
        run: |
          echo "üìä Nightly Test Report"
          echo "======================"
          go tool cover -func=unit-coverage.txt | tail -1
          
      - name: Notify on failure
        if: failure()
        run: echo "‚ùå Nightly tests failed!"

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'
      
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: results.sarif

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Check for outdated dependencies
        run: |
          go list -u -m all
          
      - name: Check for vulnerabilities
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...
